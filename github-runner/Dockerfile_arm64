# docker build --platform=linux/arm64 -t local-github-runner -f Dockerfile_arm64 .
# docker build --platform=linux/arm64 -t local-github-runner -f github-runner/Dockerfile_arm64 github-runner
# docker-compose --env-file /Users/mdaeppen/workspace/sql_quality_check/.env up

FROM python:3.10.18-slim

ARG RUNNER_VERSION="2.326.0"
ARG DEBIAN_FRONTEND=noninteractive

# Install required packages and create user
RUN apt-get update && apt-get install -y --no-install-recommends \
    unzip zip curl openjdk-17-jre python3 python3-pip python3-dev \
    build-essential git jq ca-certificates libffi-dev libssl-dev file && \
    apt-get install -y dumb-init && \
    apt-get clean && rm -rf /var/lib/apt/lists/*

# Install Sonar Scanner
RUN curl -L -o sonar-scanner.zip https://binaries.sonarsource.com/Distribution/sonar-scanner-cli/sonar-scanner-cli-5.0.1.3006.zip && \
    unzip sonar-scanner.zip -d /usr/local && \
    mv /usr/local/sonar-scanner-* /usr/local/sonar-scanner && \
    chmod +x /usr/local/sonar-scanner/bin/sonar-scanner && \
    ln -s /usr/local/sonar-scanner/bin/sonar-scanner /usr/local/bin/sonar-scanner && \
    rm sonar-scanner.zip

# Create docker user
RUN useradd -m docker

# Install GitHub Actions Runner (ARM64)
RUN mkdir -p /home/docker/actions-runner && \
    curl -LO https://github.com/actions/runner/releases/download/v${RUNNER_VERSION}/actions-runner-linux-arm64-${RUNNER_VERSION}.tar.gz && \
    tar -xzf actions-runner-linux-arm64-${RUNNER_VERSION}.tar.gz -C /home/docker/actions-runner && \
    rm actions-runner-linux-arm64-${RUNNER_VERSION}.tar.gz && \
    /home/docker/actions-runner/bin/installdependencies.sh && \
    chown -R docker /home/docker/actions-runner

# Install Snowflake CLI (SnowCLI)
RUN pip install --no-cache-dir snowflake-cli-labs

# Set environment PATH
ENV PATH="/usr/local/sonar-scanner/bin:/usr/local/bin:${PATH}"

# Copy scripts
COPY *.sh /usr/local/bin/
RUN chmod +x /usr/local/bin/*.sh

# Entrypoint
COPY entrypoint.sh /entrypoint.sh
RUN chmod +x /entrypoint.sh

USER docker
WORKDIR /home/docker/actions-runner
ENTRYPOINT ["/usr/bin/dumb-init", "--", "/entrypoint.sh"]

